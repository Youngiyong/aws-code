service: serverless-sns-sqs
# env 파일 사용
# https://www.serverless.com/framework/docs/environment-variables/
useDotenv: true

plugins:
  - serverless-plugin-typescript
  - serverless-offline
  - serverless-plugin-warmup
  # https://www.serverless.com/plugins/serverless-jest-plugin
  # - serverless-jest-plugin
  # - serverless-plugin-dynamodb-autoscaling


custom:
  # service application 내 전역적으로 사용하는 서비스 네임, 기본 리소스명이기도 함
  SERVICE_NAME: ${self:service}-${self:provider.stage}
  warmup:
    default:
     enabled: true # Whether to warm up functions by default or not
     folderName: '.warmup' # Name of the folder created for the generated warmup 
     cleanFolder: false
     memorySize: 256
     name: warmer-default
     role: WarmupRole
     tags:
      Project: foo
      Owner: bar 
     vpc: false
     events:
      - schedule: 'cron(0/5 8-17 ? * MON-FRI *)' # Run WarmUp every 5 minutes Mon-Fri between 8:00am and 5:55pm (UTC)
     package:
      individually: true
      exclude: # exclude additional binaries that are included at the serverless package level
      - ../**
      - ../../**
      include:
      - ./**
      timeout: 20
      tracing: true
      prewarm: true # Run WarmUp immediately after a deploymentlambda
      clientContext:
        source: my-custom-source
        other: '20'
      payload: 
        source: my-custom-source
        other: 20
      payloadRaw: true # Won't JSON.stringify() the payload, may be necessary for Go/AppSync deployments
      concurrency: 5 # Warm up 5 concurrent instances
    
provider:
  name: aws
  runtime: nodejs12.x
  stage: ${opt:stage, 'dev'}
  region: ap-northeast-2
  timeout: 30 # optional, in seconds, default is 6
  lambdaHashingVersion: 20201221
  # deploymentBucket:
  #   blockPublicAccess: true # Prevents public access via ACLs or bucket policies. Default is false
  #   name: ${env:DEPLOYMENT_BUCKET} # Deployment bucket name. Default is generated by the framework
  #   maxPreviousDeploymentArtifacts: 10 # On every deployment the framework prunes the bucket to remove artifacts older than this limit. The default is 5
  # endpointType: REGIONAL
  iam:
    role:
      name: ${self:custom.SERVICE_NAME}
      # path:
      statements:
        - Effect: Allow
          Action:
            - "sns:*"
          Resource: "*"
        - Effect: Allow
          Action:
            - "s3:*"
          Resource: "*"
        # api.doc will call apigateway api
        - Effect: Allow
          Action:
            - "apigateway:*"
          Resource: "*"
    environment:
      # https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-reusing-connections.html
      AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1
      # 기본 : 배포설정, argements 로 입력
      STAGE: ${self:provider.stage}
      # 기본 : labda 타임존 설정
      TZ: "Asia/Seoul"

#Reference https://www.serverless.com/framework/docs/providers/aws/events/sns/
functions:
  lambdaHook:
    handler: src/handler.lambdaHook
    events:
      - http:
          path: /lambdahook
          description: "Lambda SNS Test"
          method: get
          cors:
            origin: "*"
            headers: "*"
  sns:
    handler: src/handler.sns
    events:
      - sns:
        arn: !Ref LambdaTopic
        topicName: LambdaSNSTopic  
    warmup:
      default:
        enabled: false
  snsEventLambda:
    handler: src/handler.snsEvent
    events:
      - http:
          path: /snsEvent
          description: "Lambda SNS Test"
          method: get
          cors:
            origin: "*"
            headers: "*"
    warmup:
      default:
        enabled: false

# - sns
resources:
  Resources:
    LambdaTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: LambdaSNSTopic